{% extends "base.html" %}
{% load static %}
{% block title %}Admin Dashboard - YourNews{% endblock %}
{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-12">
      <h2 class="mb-4">Admin Dashboard - Role Applications</h2>
      <!-- Summary Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title">Total Applications</h5>
              <h2>{{ total_count }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <h5 class="card-title">Pending Review</h5>
              <h2>{{ pending_count }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h5 class="card-title">Approved</h5>
              <h2>{{ approved_count }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-danger text-white">
            <div class="card-body">
              <h5 class="card-title">Rejected</h5>
              <h2>{{ rejected_count }}</h2>
            </div>
          </div>
        </div>
      </div>
      <!-- Applications Tabs -->
      <ul class="nav nav-tabs" id="applicationTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active"
                  id="pending-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#pending"
                  type="button"
                  role="tab"
                  aria-controls="pending"
                  aria-selected="true">Pending Applications ({{ pending_count }})</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  id="approved-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#approved"
                  type="button"
                  role="tab"
                  aria-controls="approved"
                  aria-selected="false">Approved ({{ approved_count }})</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  id="rejected-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#rejected"
                  type="button"
                  role="tab"
                  aria-controls="rejected"
                  aria-selected="false">Rejected ({{ rejected_count }})</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  id="all-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#all"
                  type="button"
                  role="tab"
                  aria-controls="all"
                  aria-selected="false">All Applications ({{ total_count }})</button>
        </li>
      </ul>
      <!-- Tab Content -->
      <div class="tab-content" id="applicationTabsContent">
        <!-- Pending Applications Tab -->
        <div class="tab-pane fade show active"
             id="pending"
             role="tabpanel"
             aria-labelledby="pending-tab">
          <div class="mt-3">
            {% if pending_applications %}
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-warning">
                    <tr>
                      <th>User</th>
                      <th>Applied Role</th>
                      <th>Motivation</th>
                      <th>Submitted</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for application in pending_applications %}
                      <tr>
                        <td>
                          <strong>{{ application.user.username }}</strong>
                          <br>
                          <small class="text-muted">{{ application.user.email }}</small>
                          {% if application.user.get_full_name %}
                            <br>
                            <small>{{ application.user.get_full_name }}</small>
                          {% endif %}
                        </td>
                        <td>
                          <strong>{{ application.applied_role|capfirst }}</strong>
                        </td>
                        <td>
                          <div class="motivation-text">{{ application.motivation|truncatewords:20 }}</div>
                          {% if application.motivation|length > 100 %}
                            <button class="btn btn-link btn-sm p-0"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#motivation-{{ application.id }}"
                                    aria-expanded="false">Show full motivation</button>
                            <div class="collapse mt-2" id="motivation-{{ application.id }}">
                              <div class="card card-body">{{ application.motivation }}</div>
                            </div>
                          {% endif %}
                        </td>
                        <td>{{ application.submitted_at|date:"M d, Y H:i" }}</td>
                        <td>
                          <div class="btn-group" role="group">
                            <!-- Approve Button -->
                            <a href="#"
                               class="btn btn-success btn-sm"
                               data-bs-toggle="modal"
                               data-bs-target="#approveModal-{{ application.id }}">Approve</a>
                            <!-- Reject Button -->
                            <a href="#"
                               class="btn btn-danger btn-sm"
                               data-bs-toggle="modal"
                               data-bs-target="#rejectModal-{{ application.id }}">Reject</a>
                          </div>
                          <!-- Approve Modal -->
                          <div class="modal fade"
                               id="approveModal-{{ application.id }}"
                               tabindex="-1">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <form method="post"
                                      action="{% url 'news:approve_role_application' application.pk %}">
                                  {% csrf_token %}
                                  <div class="modal-header">
                                    <h5 class="modal-title">Approve Application</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                  </div>
                                  <div class="modal-body">
                                    <p>
                                      Approve <strong>{{ application.user.username }}</strong>'s <strong>{{ application.applied_role }}</strong> application?
                                    </p>
                                    {% if application.applied_role == "journalist" or application.applied_role == "editor" %}
                                      <div class="mb-3">
                                        <label for="publisher-{{ application.id }}" class="form-label">Assign to Publisher:</label>
                                        <select class="form-select"
                                                name="publisher"
                                                id="publisher-{{ application.id }}"
                                                required>
                                          <option value="">Select a publisher...</option>
                                          {% for publisher in publishers %}<option value="{{ publisher.id }}">{{ publisher.name }}</option>{% endfor %}
                                        </select>
                                      </div>
                                    {% endif %}
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-success">Approve Application</button>
                                  </div>
                                </form>
                              </div>
                            </div>
                          </div>
                          <!-- Reject Modal -->
                          <div class="modal fade"
                               id="rejectModal-{{ application.id }}"
                               tabindex="-1">
                            <div class="modal-dialog">
                              <div class="modal-content">
                                <form method="post"
                                      action="{% url 'news:reject_role_application' application.pk %}">
                                  {% csrf_token %}
                                  <div class="modal-header">
                                    <h5 class="modal-title">Reject Application</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                  </div>
                                  <div class="modal-body">
                                    <p class="text-danger">
                                      <i class="fas fa-exclamation-triangle me-2"></i>Are you sure you want to reject <strong>{{ application.user.username }}</strong>'s <strong>{{ application.applied_role }}</strong> application?
                                    </p>
                                    <p class="text-muted small">This action cannot be undone. The applicant will be notified of the rejection.</p>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger">Reject Application</button>
                                  </div>
                                </form>
                              </div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">No pending applications at the moment.</div>
            {% endif %}
          </div>
        </div>
        <!-- Approved Applications Tab -->
        <div class="tab-pane fade"
             id="approved"
             role="tabpanel"
             aria-labelledby="approved-tab">
          <div class="mt-3">
            {% if approved_applications %}
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-success">
                    <tr>
                      <th>User</th>
                      <th>Applied Role</th>
                      <th>Submitted</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for application in approved_applications %}
                      <tr>
                        <td>
                          <strong>{{ application.user.username }}</strong>
                          <br>
                          <small class="text-muted">{{ application.user.email }}</small>
                          {% if application.user.get_full_name %}
                            <br>
                            <small>{{ application.user.get_full_name }}</small>
                          {% endif %}
                        </td>
                        <td>
                          <strong>{{ application.applied_role|capfirst }}</strong>
                        </td>
                        <td>{{ application.submitted_at|date:"M d, Y H:i" }}</td>
                        <td>
                          <span class="badge bg-success">Approved</span>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">No approved applications yet.</div>
            {% endif %}
          </div>
        </div>
        <!-- Rejected Applications Tab -->
        <div class="tab-pane fade"
             id="rejected"
             role="tabpanel"
             aria-labelledby="rejected-tab">
          <div class="mt-3">
            {% if rejected_applications %}
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-danger">
                    <tr>
                      <th>User</th>
                      <th>Applied Role</th>
                      <th>Motivation</th>
                      <th>Submitted</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for application in rejected_applications %}
                      <tr>
                        <td>
                          <strong>{{ application.user.username }}</strong>
                          <br>
                          <small class="text-muted">{{ application.user.email }}</small>
                          {% if application.user.get_full_name %}
                            <br>
                            <small>{{ application.user.get_full_name }}</small>
                          {% endif %}
                        </td>
                        <td>
                          <strong>{{ application.applied_role|capfirst }}</strong>
                        </td>
                        <td>
                          <div class="motivation-text">{{ application.motivation|truncatewords:15 }}</div>
                        </td>
                        <td>{{ application.submitted_at|date:"M d, Y H:i" }}</td>
                        <td>
                          <span class="badge bg-danger">Rejected</span>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">No rejected applications.</div>
            {% endif %}
          </div>
        </div>
        <!-- All Applications Tab -->
        <div class="tab-pane fade"
             id="all"
             role="tabpanel"
             aria-labelledby="all-tab">
          <div class="mt-3">
            {% if applications %}
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>User</th>
                      <th>Applied Role</th>
                      <th>Status</th>
                      <th>Submitted</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for application in applications %}
                      <tr>
                        <td>
                          <strong>{{ application.user.username }}</strong>
                          <br>
                          <small class="text-muted">{{ application.user.email }}</small>
                          {% if application.user.get_full_name %}
                            <br>
                            <small>{{ application.user.get_full_name }}</small>
                          {% endif %}
                        </td>
                        <td>
                          <strong>{{ application.applied_role|capfirst }}</strong>
                        </td>
                        <td>
                          <span class="badge {% if application.status == 'approved' %}bg-success{% elif application.status == 'rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                            {{ application.status|capfirst }}
                          </span>
                        </td>
                        <td>{{ application.submitted_at|date:"M d, Y H:i" }}</td>
                        <td>
                          {% if application.status == 'pending' %}
                            <div class="btn-group" role="group">
                              <a href="#"
                                 class="btn btn-success btn-sm"
                                 data-bs-toggle="modal"
                                 data-bs-target="#approveModal-all-{{ application.id }}">Approve</a>
                              <a href="#"
                                 class="btn btn-danger btn-sm"
                                 data-bs-toggle="modal"
                                 data-bs-target="#rejectModal-all-{{ application.id }}">Reject</a>
                            </div>
                            <!-- Approve Modal for All tab -->
                            <div class="modal fade"
                                 id="approveModal-all-{{ application.id }}"
                                 tabindex="-1">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <form method="post"
                                        action="{% url 'news:approve_role_application' application.pk %}">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                      <h5 class="modal-title">Approve Application</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                      <p>
                                        Approve <strong>{{ application.user.username }}</strong>'s <strong>{{ application.applied_role }}</strong> application?
                                      </p>
                                      {% if application.applied_role == "journalist" or application.applied_role == "editor" %}
                                        <div class="mb-3">
                                          <label for="publisher-all-{{ application.id }}" class="form-label">Assign to Publisher:</label>
                                          <select class="form-select"
                                                  name="publisher"
                                                  id="publisher-all-{{ application.id }}"
                                                  required>
                                            <option value="">Select a publisher...</option>
                                            {% for publisher in publishers %}<option value="{{ publisher.id }}">{{ publisher.name }}</option>{% endfor %}
                                          </select>
                                        </div>
                                      {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button type="submit" class="btn btn-success">Approve Application</button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                            <!-- Reject Modal for All tab -->
                            <div class="modal fade"
                                 id="rejectModal-all-{{ application.id }}"
                                 tabindex="-1">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <form method="post"
                                        action="{% url 'news:reject_role_application' application.pk %}">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                      <h5 class="modal-title">Reject Application</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                      <p class="text-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Are you sure you want to reject <strong>{{ application.user.username }}</strong>'s <strong>{{ application.applied_role }}</strong> application?
                                      </p>
                                      <p class="text-muted small">This action cannot be undone. The applicant will be notified of the rejection.</p>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button type="submit" class="btn btn-danger">Reject Application</button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                          {% else %}
                            <span class="text-muted">No actions available</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">No role applications have been submitted yet.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
